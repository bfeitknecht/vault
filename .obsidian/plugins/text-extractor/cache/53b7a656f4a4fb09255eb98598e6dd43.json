{"path":"sem4/CN/VRL/extra/10-BGP.pdf","text":"Computer Networks: BGP Adrian Perrig Slides based on lectures by Laurent Vanbever, Jennifer Rexford, Scott Shenker Photo: ETH Zürich / Gian Marco Castelberg Intra-domain routing1 Inter-domain routing Path-vector protocols Link-state protocols Distance-vector protocols Internet routing from here to there, and back 2 Each router broadcasts its own link state to give every router a complete view of the graph Each router keeps track of its incident links and cost as well as whether link is up (available) or down (unavailable) Routers run Dijkstra on the corresponding graph to compute their shortest-path and forwarding tables In Link-State routing, routers build a precise map of the network by flooding local views to everyone 3 control-plane consistency all nodes have the same link-state database the global forwarding state directs packet to its destination necessary forwarding validity During network changes, the link-state database of each node might differ 4 see http://bit.ly/2olXtnF Inconsistencies lead to transient disruptions in the form of blackholes or forwarding loops 5 Let dx(y) be the cost of the least-cost path known by x to reach y Each node bundles these distances into one message (called a vector) that it repeatedly sends to all its neighbors Each node updates its distances based on neighbors’ vectors: dx(y) = min{ c(x,v) + dv(y) } over all neighbors v until convergence Unlike Link-State protocols, Distance-Vector protocols converge slowly Distance-vector protocols are based on Bellman-Ford algorithm 6 Link-state protocols Intra-domain routing Distance-vector protocols Inter-domain routing2 Path-vector protocols Internet routing from here to there, and back 7 AS10 AS20 AS30 AS40 AS50 The Internet is a network of networks, referred to as Autonomous Systems (AS) 8 AS10 AS20 AS30 AS40 AS50 BGP sessions BGP is the routing protocol “glueing” the Internet together 9 129.132.0.0/16 ETH/UNIZH Camp Net AS40 Using BGP, ASes exchange information about the IP prefixes they can reach, directly or indirectly 10 BGP needs to solve three key challenges: scalability, privacy and policy enforcement 11 Networks don’t want to divulge internal topologies or their business relationships There is a large number of networks and prefixes 900k prefixes, >85,000 networks, millions (!) of routers Networks needs to control where to send and receive traffic without an Internet-wide notion of a link cost metric Requires each node to compute the entire path high processing overhead Floods topology information high communication and processing overhead Minimizes some notion of total distance works only if the policy is shared and uniform Link-State routing does not solve these challenges 12 Distance-Vector routing is on the right track, Hide details of the network topology nodes determine only “next-hop” for each destination pros 13 It still minimizes some common distance impossible to achieve in an inter domain setting It converges slowly counting-to-infinity problem cons Distance-Vector routing is on the right track, but not really there yet… Hide details of the network topology nodes determine only “next-hop” for each destination pros 14 key idea advertise the entire AS-level path instead of distances BGP relies on path-vector routing to support flexible routing policies and avoid count-to-infinity 15 AS10 AS20 AS30 AS50 129.132.0.0/16 ETH/UNIZH Camp Net 129.132.0.0/16 Path: 40 129.132.0.0/16 Path: 40 AS40 BGP announcements carry complete AS-level path information instead of distances 16 AS10 AS20 AS30 AS50 129.132.0.0/16 ETH/UNIZH Camp Net 129.132.0.0/16 Path: 10 40 AS40 Each AS appends itself to the path when it propagates announcements 17 AS10 AS20 AS30 AS50 129.132.0.0/16 ETH/UNIZH Camp Net 129.132.0.0/16 Path: 50 10 40 129.132.0.0/16 Path: 10 40 AS40 18 Follow the Money BGP Policies1 Protocol How does it work? Problems security, performance, … Border Gateway Protocol policies and more 19 AS10 AS20 AS30 AS40 AS50 The Internet topology is shaped according to business relationships 20 ASes connect only if they have a business relationship BGP is a “follow the money” protocol Intuition 21 Said in another way: ASes connect only if they can earn money or save money (to achieve connectivity) We will cover the 2 main business relationships today: • customer/provider • peer/peer many less important ones (siblings, backups,…) 22 We will cover the 2 main business relationships today: • customer/provider • peer/peer 23 provider customer $$$ Customers pay providers to get Internet connectivity 24 Every 5 minutes, DT At the end of the month, DT • sorts all values in decreasing order • removes the top 5% values • bills wrt highest remaining value records the # of bytes sent/received The amount paid is based on peak usage, usually according to the 95th percentile rule 25 Sample 95th percentile pricing 26 10 Mbps 100 Mbps Gbps1 10 100 Gbps Gbps commit unit price ($/Mbps) 12 5 3.50 1.20 0.70 Minimum monthly bill ($/month) 120 500 3,500 12,000 70,000 Examples taken from The 2014 Internet Peering Playbook Most ISPs discount traffic unit price when pre-committing to certain volume 27 The reason? Internet commoditization & competition Internet Transit Prices have been continuously declining during the last 20 years 28 We will cover the 2 main business relationships today: • customer/provider • peer/peer 29 peer peer DT and ATT exchange tons of traffic. they save money by directly connecting to each other Peers don’t pay each other for connectivity, they do it out of common interest 30 To understand Internet routing, follow the money 3132 Providers transit traffic for their customers allowed allowed 33 Peers do not transit traffic between each other forbidden 34 forbidden Customers do not transit traffic between their providers 35 ExportSelection which path to use? which path to advertise? These policies are defined by constraining which BGP routes are selected and exported 36 Export which path to advertise? control outbound traffic Selection which path to use? 37 129.132.0.0/16 Path: 50 10 40 129.132.0.0/16 Path: 10 40 always prefer Deutsche Telekom routes over AT&T 38 always prefer Deutsche Telekom routes over AT&T IP traffic 39 For a destination p, prefer routes coming from • customers over • peers over • providers route type Business relationships conditions route selection 40 ExportSelection which path to use? which path to advertise? defines which inbound traffic is allowed 41 129.132.0.0/16 Path: 40 do not export ETH routes to AT&T 42 do not export ETH routes to AT&T 43 from send to peer provider customer peer provider customer Business relationships conditions route exportation 44 from send to peer provider customer peer provider customer ✓ ✓ ✓ Routes coming from customers are propagated to everyone else 45 from send to peer provider customer peer provider customer ✓ ✓ - - - - Routes coming from peers and providers are only propagated to customers 46 Export which path to advertise? defines which inbound traffic is allowed control outbound traffic Selection which path to use? 47 AS A AS B AS C AS D AS E AS F AS G AS H AS I 48 AS A AS D provider customer 49 AS D AS E peer peer 50 Is (B, A, D) a valid path? Yes/No AS A AS B AS D 51 Is (H, E, D) a valid path? Yes/No AS D AS E AS H 52 AS A AS B AS D AS E AS G AS H Is (G,D,A,B,E,H) a valid path? Yes/No 53 Will (G,D,A,B,E,H) actually see packets? Yes/No 54 AS A AS B AS D AS E AS G AS H What’s a valid path between G and I? AS A AS B AS C AS D AS E AS F AS G AS H AS I 55 None! This Internet is partitioned… AS A AS B AS C AS D AS E AS F AS G AS H AS I 56 Tier-1s must be connected through a full-mesh of peer links AS A AS B AS C AS D AS E AS F AS G AS H AS I 57 What’s a valid path between G and I? AS A AS B AS C AS D AS E AS F AS G AS H AS I 58 Follow the Money BGP Policies Protocol How does it work? 2 Problems security, performance, … Border Gateway Protocol policies and more 60 BGP sessions come in two flavors: eBGP and iBGP AS10 AS20 AS30 AS40 AS50 62 eBGP session external BGP (eBGP) sessions connect border routers in different ASes 63 129.132.0.0/16 Path: 20 eBGP sessions are used to learn routes to external destinations 64 iBGP sessions Internal BGP (iBGP) sessions connect the routers in the same AS 65 129.132.0.0/16 Path: 20 129.132.0.0/16 Path: 20 129.132.0.0/16 Path: 20 129.132.0.0/16 Path: 20 129.132.0.0/16 Path: 20 iBGP sessions are used to disseminate externally-learned routes internally 66 learned via IGP (e.g., OSPF) 129.132.0.0/16 Path: 20 I can reach “129.132/16” via SEAT, internal NH is CHIC 67 129.132.0.0/16 Path: 10 20 Routes disseminated internally are then announced externally again, using eBGP sessions 68 open notification update keepalive establish a TCP-based BGP session report unusual conditions inform neighbor of a new best route inform neighbor that the connection is alive • a change in the best route • the removal of the best route On the wire, BGP is a rather simple protocol composed of four basic messages 69 IP prefix Attributes used in route selection/export decisions Describe route properties are either local or global (only seen on iBGP) (seen on iBGP and eBGP) BGP UPDATEs carry an IP prefix together with a set of attributes 70 LOCAL-PREF outbound traffic control MED inbound traffic control AS-PATH loop avoidance outbound traffic control inbound traffic control NEXT-HOP egress point identification 71 Attributes and their usage 82.130.64.0/18 NEXT-HOP: 11.0.0.1 82.130.64.0/18 NEXT-HOP: 10.0.0.1 AS 40 AS 50 AS 10 10.0.0.1 10.0.0.2 11.0.0.1 11.0.0.2 82.130.64.0/18 NEXT-HOP: 10.0.0.1 The NEXT-HOP is set when the route enters an AS, it does not change within the AS The NEXT-HOP is a global attribute which indicates where to send the traffic next 72 82.130.64.0/18 AS-PATH: 10 40 82.130.64.0/18 AS-PATH: 40 AS 40 AS 50 AS 10 The AS-PATH is a global attribute that lists all the ASes a route has traversed (in reverse order) 73 Provider #2 ($) Provider #1 ($$) 1 10 100 5 set LOCAL-PREF to 100set LOCAL-PREF to 50 The LOCAL-PREF is a local attribute set at the border of an incoming update, representing how “preferred” a route is within the AS 74 1 10 100 5 set LOCAL-PREF to 100 forwarding paths By setting a higher LOCAL-PREF, all routers end up using DT to reach any external prefixes, even if they are closer (IGP-wise) to the Swisscom egress set LOCAL-PREF to 50 75 The MED (Multi-Exit Discriminator) is a global attribute which encodes the relative “proximity” of a prefix wrt to the announcer In contrast to LOCAL-PREF, a lower MED value indicates closeness and is preferred over a higher value 76 1 10 100 5 p: 82.130.64.0/18 p p Swisscom receives two routes to reach p and chooses (arbitrarily) its left router as egress 1 1 77 1 10 100 5 p: 82.130.64.0/18 p p Swisscom receives two routes to reach p and chooses (arbitrarily) its left router as egress 1 1 78 1 10 100 5 p: 82.130.64.0/18 p p Yet, ETH would prefer to receive traffic for p on its right border router which is closer to the actual destination 1 1 79 1 10 100 5 set MED to 20 p: 82.130.64.0/18 set MED to 10 p p 1 1 ETH can communicate that preference to Swisscom by setting a higher MED on p when announced from the left 80 1 10 100 5 p: 82.130.64.0/18 p p Swisscom receives two routes to reach p and, given it does not cost it anything more, chooses its right router as egress 1 1 81 Swisscom receives two routes to reach p and, given it does not cost it anything more, chooses its right router as egress But what if it does? 82 1 10 100 5 set MED to 20 p: 82.130.64.0/18 set MED to 10 p p 1 1 Consider that Swisscom always prefer to send traffic via its left egress point (bigger router, less costly) smaller router, set LOCAL-PREF to 50 big router set LOCAL-PREF to 200 83 1 10 100 5 set MED to 20 p: 82.130.64.0/18 set MED to 10 p p 1 1 In this case, Swisscom will not care about the MED value and still push the traffic via its left router smaller router, set LOCAL-PREF to 50 big router set LOCAL-PREF to 200 84 Lesson The network which is sending the traffic always has the final word when it comes to deciding where to forward The network which is receiving the traffic can just try to influence remote decisions, Corollary not control them 85 1 10 100 5 p: 82.130.64.0/18 ETH cannot use the MED to move incoming traffic to Swisscom With the MED, an AS can influence its inbound traffic between multiple connections towards the same AS 86 BGP UPDATEs carry an IP prefix together with a set of attributes IP prefix Attributes used in route selection/export decisions Describe route properties are either local or global (only seen on iBGP) (seen on iBGP and eBGP) 87 Each BGP router processes UPDATEs according to a precise pipeline 88 IP forwarding table forwarding entries IP packets IP packets 89 BGP is thus a single path protocol Given the set of all acceptable routes for each prefix, the BGP Decision process elects a single route 90 Prefer routes… with higher LOCAL-PREF with shorter AS-PATH length with lower MED learned via eBGP instead of iBGP with lower IGP metric to the next-hop with smaller egress IP address (tie-break) 91 learned via eBGP instead of iBGP with lower IGP metric to the next-hop 92 These two steps aim at directing traffic as quickly as possible out of the AS (early exit routing or also called hot potato routing) 93 multiple peering points Customer B Customer A Provider A Provider B ASes are selfish They dump traffic as soon as possible to someone else This leads to asymmetric routing Traffic often does not flow on same path in both directions 94 Let’s look at how operators implement customer/provider and peer policies in practice 95 For a destination p, prefer routes coming from • customers over • peers over • providers route type To implement their selection policy, operators define input filters which manipulates the LOCAL-PREF 96 AS10 AS 30 peer AS 40 provider AS 20 customer input filter: match *, set LP := 200 input filter: match *, set LP := 100 input filter: match *, set LP := 50 97 from send to peer provider customer peer provider customer ✓ ✓ ✓ ✓ ✓ - - - - To implement their export rules, operators use a mix of import and export filters 98 AS10 AS 30 peer AS 40 provider AS 20 customer input filter: match *, set TAG := CUST output filter: match TAG = *, allow input filter: match *, set TAG := PEER output filter: match TAG = CUST, allow else deny input filter: match *, set TAG := PROV output filter: match TAG = CUST, allow else deny 99 Follow the Money BGP Policies Protocol How does it work? Problems security, performance, … 3 Border Gateway Protocol policies and more 100 BGP suffers from many rampant problems Reachability Security Convergence Performance Anomalies Relevance Problems 101 Because of policies, Swisscom cannot reach DT even if the graph is connected Unlike normal routing, policy routing does not guarantee reachability even if the graph is connected 102 Reachability Security Convergence Performance Anomalies Relevance Problems 103 ASes can arbitrarily modify route content e.g., change the content of the AS-PATH ASes can advertise any prefixes even if they don’t own them! ASes can forward traffic along different paths than the advertised one Security considerations are simply absent from BGP specifications 104 Reachability Security Convergence Performance Anomalies Relevance Problems 105 With arbitrary policies, BGP may fail to converge 106 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 107 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 preference list 1 prefers to reach 0 via 3 rather than directly 108 Initially, all ASes only know the direct route to 0 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 forwarding path 109 AS 1 advertises its path to AS 2 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 110 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 2 switches to 2 1 0 (preferred) 111 AS 3 advertises its path to AS 1 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 112 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 1 switches to 1 3 0 (preferred) 113 AS 1 advertises its new path 1 3 0 to AS 2 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 114 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 2 reverts back to its initial path 2 0 115 AS 2 advertises its path 2 0 to AS 3 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 116 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 3 switches to 3 2 0 (preferred) 117 AS 3 advertises its new path 3 2 0 to AS 1 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 118 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 1 reverts back to 1 0 (initial path) 119 AS 1 advertises its new path 1 0 to AS 2 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 120 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 2 switches to 2 1 0 (preferred) 121 AS 2 advertises its new path 2 1 0 to AS 3 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 122 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 Upon reception, AS 3 switches to its initial path 3 0 123 1 2 3 0 1 3 0 1 0 3 2 0 3 0 2 1 0 2 0 AS 1 AS 2 AS 3 AS 0 We are back where we started, from there on, the oscillation will continue forever 124 Guaranteeing the absence of oscillations is hard even when you know all the policies! ASes are free to chose and advertise any paths they want network stability argues against this Policy oscillations are a direct consequence of policy autonomy 125 Theorem If all AS policies follow the cust/peer/provider rules, BGP is guaranteed to converge Intuition Oscillations require “preferences cycles” which make no economic sense known as “Gao-Rexford” rules In practice though, BGP does not oscillate “that” often 128129 Reachability Security Convergence Performance Anomalies Relevance Problems AS 4 AS 3 AS 2 AS 1 BGP says that path 4 1 is better than path 3 2 1 BGP path selection is mostly based on economics, not based on accurate performance criteria 130 Reachability Security Convergence Performance Anomalies Relevance Problems 131 BGP configuration is hard to get right BGP is often manually configured humans frequently make mistakes BGP is both “bloated” and underspecified lots of knobs and (sometimes, conflicting) interpretations BGP abstraction is fundamentally flawed disjoint, router-based configuration to effect AS-wide policy 132 “Human factors are responsible for 50% to 80% of network outages” Juniper Networks, What’s Behind Network Downtime?, 2008 133 Reachability Security Convergence Performance Anomalies Relevance Problems 134 The world of BGP policies is rapidly changing Transit becomes less important and less profitable traffic increasingly moves to interconnection points ISPs are now eyeballs talking to content networks e.g., Swisscom and Netflix/Spotify/YouTube No systematic practices, yet details of peering arrangements are private anyway 135 FCC issued a notice of inquiry on secure Internet routing https://docs.fcc.gov/public/attachments/FCC-22-18A1.pdf Our response https://cloud.inf.ethz.ch/s/aAazqek544XHbcE BGP / BGPsec report Response to FCC Notice of Inquiry 136","libVersion":"0.3.2","langs":""}